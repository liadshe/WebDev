<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Statistics</title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">

</head>
<body class="settings-page">
  <div class="sidebar">
    <a href="/main" class="back-link">‚Üê Back to main page</a>
    <a href="/settings">Manage Profiles</a>
    <a href="/statistics" class="active">Statistics</a>
  </div>

  <div style="margin: auto;">
    <h2>Profiles Genres Preferences</h2>
    <canvas id="genrePopularityChart"></canvas>
    <p id="no-genre-data" style="display:none; text-align:center; color:gray;">No data available.</p>
  </div>

  <div style="margin: auto;">
    <h2>Profiles Daily Watch Time (minutes)</h2>
    <canvas id="dailyWatchChart"></canvas>
    <p id="no-watch-data" style="display:none; text-align:center; color:gray;">No data available.</p>
  </div>

  <script>
    // GENRES CHART
    const genreData = <%- JSON.stringify(genreData || []) %>;
    if (genreData.length > 0) {
      const labels = genreData.map(item => item.label);
      const dataValues = genreData.map(item => item.value);
      const bgColors = labels.map(() => `hsl(${Math.random()*360}, 70%, 60%)`);
      const ctx1 = document.getElementById('genrePopularityChart').getContext('2d');
      new Chart(ctx1, {
        type: 'pie',
        data: { labels, datasets: [{ data: dataValues, backgroundColor: bgColors }] },
        options: { responsive: true, plugins: { legend: { position: 'left' } } }
      });
    } else document.getElementById('no-genre-data').style.display = 'block';


    // DAILY WATCH CHART
    const dailyWatchData = <%- JSON.stringify(dailyWatchData || []) %>;

    if (dailyWatchData.length > 0) {
      // Extract unique dates and profiles
      const dates = [...new Set(dailyWatchData.map(d => d._id.date))];
      const profiles = [...new Set(dailyWatchData.map(d => d._id.profile))];

      // Create dataset for each profile
      const datasets = profiles.map(profile => {
        const data = dates.map(date => {
          const entry = dailyWatchData.find(
            d => d._id.date === date && d._id.profile === profile
          );
          return entry ? (entry.totalSeconds / 60).toFixed(1) : 0; // convert to minutes
        });
        return {
          label: profile,
          data,
          backgroundColor: `hsl(${Math.random()*360}, 70%, 60%)`
        };
      });

      const ctx2 = document.getElementById('dailyWatchChart').getContext('2d');
      new Chart(ctx2, {
        type: 'bar',
        data: { labels: dates, datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: false }
          },
          scales: {
            y: { title: { display: true, text: "Minutes Watched" }, beginAtZero: true }
          }
        }
      });
    } else document.getElementById('no-watch-data').style.display = 'block';
  </script>
</body>
</html>
