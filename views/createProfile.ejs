<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create New Profile</title>
<link rel="stylesheet" href="/css/settings.css">
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">

</head>
<body class="edit-profile-page">
<a href="/settings">
    ‚Üê Back 
</a> 
    <div class="card-bg">
    <h2>
    Create New Profile 
</h2>
    <% if (typeof profilesCount !== 'undefined' && profilesCount >= 5) { %>
        <div class="warning" style="color:var(--color-red-400); margin-bottom:1rem;">
            You already have <strong><%= profilesCount %></strong> profiles. The maximum allowed is 5. Delete a profile to create a new one.
        </div>
    <% } %>
<div class="flex-container">
    <div class="col-left">
        <img id="current-profile-picture" 
                src="/images/cow.jpg" >
                <button id="open-picture-modal">
            Choose Avatar
        </button>                                
</div>
<div class="col-right">
    <form id="create-profile-form" action="/api/profiles/createProfile" method="POST">
        <input type="hidden" name="action" value="create_profile">
        <section style="text-align: left;">
            <h3>Profile Name</h3>
            <input type="text" id="displayName" name="displayName" 
                                value="" 
                                required minlength="2" maxlength="50"
                                placeholder="">
        </section>

        <section style="text-align: left; margin-top:1rem;">
            <h3>Genres Preferences</h3>
            <div class="pref-box">
                <% genres.forEach(genre => { %>
                    <label class="pref-label">
                    <input
                        type="checkbox"
                        name="preferences"
                        value="<%= genre %>"
                    />
                    <span class="text-sm font-medium text-white"><%= genre %></span>
                </label>
            <% }) %>
        </div>
</section>

<input type="hidden" name="newPicture" id="new-picture-input">
<input type="hidden" name="picture" id="picture-input">

<div style="margin-top:1rem;">
        <% if (typeof profilesCount !== 'undefined' && profilesCount >= 5) { %>
            <button type="submit" class="btn" disabled title="Maximum profiles reached">Create Profile</button>
        <% } else { %>
            <button type="submit" class="btn">Create Profile</button>
        <% } %>
</div>

    </form>
</div>
</div>
</div>
</div>
<div id="picture-modal">
<div class="modal-content">
    <h3 class="text-2xl font-bold mb-6 text-white">Select New Avatar</h3>
    <% 
        const availableAvatars = ['cow.jpg', 'horse.jpg', 'mouse.jpg', 'pig.jpg'];
    %>

    <div class="avatar-grid">
        <% availableAvatars.forEach(avatar => { %>
            <div style="position: relative;">
                <img src="<%= "/images/" + avatar %>" 
                        alt="<%= avatar %>" 
                        data-picture-name="<%= avatar %>"
                        class="avatar-select">
            </div>
        <% }); %>
    </div>

    <div style="display: flex; justify-content: flex-end; column-gap: 1rem; margin-top: 1.5rem;">
        <button id="close-picture-modal" class="btn-secondary" type="button">Cancel</button>
        <button id="save-picture-btn" class="btn-secondary" type="button" disabled>Save New Picture</button>
    </div>
</div>
</div>

<script>
const pictureModal = document.getElementById('picture-modal');
const openModalBtn = document.getElementById('open-picture-modal');
const closeModalBtn = document.getElementById('close-picture-modal');
const savePictureBtn = document.getElementById('save-picture-btn');
const newPictureInput = document.getElementById('new-picture-input');
const pictureInput = document.getElementById('picture-input');
const avatarSelectors = document.querySelectorAll('.avatar-select');
let selectedPicture = '';

// Open Modal
openModalBtn.addEventListener('click', () => {
    pictureModal.classList.remove('hidden');
    pictureModal.classList.add('flex');
    savePictureBtn.disabled = true; 
    newPictureInput.value = ""; 
});


// Close Modal
closeModalBtn.addEventListener('click', () => {
    pictureModal.classList.add('hidden');
    pictureModal.classList.remove('flex');
});

// Handle Avatar Selection
avatarSelectors.forEach(img => {
    img.addEventListener('click', () => {
        const pictureName = img.dataset.pictureName;

        avatarSelectors.forEach(i => {
            i.classList.remove('selected');
            i.style.borderColor = 'transparent';
        });

        img.classList.add('selected');
        img.style.borderColor = '#f58799';

        selectedPicture = pictureName;
        newPictureInput.value = pictureName;
        savePictureBtn.disabled = false;
    });
});

savePictureBtn.addEventListener('click', (e) => {
    e.preventDefault();
    pictureModal.classList.add('hidden');
    pictureModal.classList.remove('flex');
    if (selectedPicture) {
        const preview = document.getElementById('current-profile-picture');
        if (preview) preview.src = '/images/' + selectedPicture;
        if (pictureInput) pictureInput.value = selectedPicture;
    }
});
</script>
</body>
</html>
